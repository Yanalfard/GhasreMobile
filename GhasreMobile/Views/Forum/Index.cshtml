@model IEnumerable<TblTopic>
@{
    ViewData["Title"] = "تالار گفتگو";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles{
    <link href="~/css/pages/forum.min.css" rel="stylesheet" />
}

@section Aside{

    <div class="mat-card" swap="swNewForum">
        <h3>موضوع جدید</h3>
        <p>موضوعی برای بحث دارید؟ آن را به اشتراک بگزارید</p>
        <a href="/Forum/NewForum" class="btn btn-primary">ثبت موضوع</a>
    </div>

    @await Component.InvokeAsync("AdView")
    @await Component.InvokeAsync("AdView")

}

<nav class="breadcrumb uk-padding-remove">
    <a href="#">تالار گفتگو</a>
    <a href="#" class="active">صفحه اصلی</a>
</nav>

<div role="none" id="swNewForum"></div>
@if (Context.Request.Query["addForum"].ToString() == "true")
{
    <div class="uk-alert uk-alert-success">
        <p class="help-block">پیام شما ثبت شد و بعد از بررسی در تالار گفتوگو قرار خواهد گرفت</p>
    </div>
}
<div class="threads col">
    @foreach (var item in Model)
    {
        <partial name="_ThreadBlock" model="item" />
    }
</div>

@section Scripts{
    <script src="~/js/BjaxLib.js"></script>

    <script>
        $.get('https://www.cloudflare.com/cdn-cgi/trace',
            function (data) {
                console.log(data);
                console.log(data.split('ip=')[1].split('ts')[0]);
            });

        // Vote List
        const votelistKey = "votelist";
        // [{id,isUp},{5,true}]
        let votelist = JSON.parse(localStorage.getItem(votelistKey)) || [];

        if (votelist.length > 0) {
            for (let vote of votelist) {

                let val = vote.id;
                //#region buts
                var voteDOM = document.getElementById('Vote' + val);
                if (vote.isUp) {
                    const up = voteDOM.parentElement.querySelector('.up');
                    up.classList.add('link-active');
                }
                else if (!vote.isUp) {
                    const down = voteDOM.parentElement.querySelector('.down');
                    down.classList.add('link-active');
                }
                //#endregion
            }
        }

        function VoteUp(val) {

            //#region buts
            var vote = document.getElementById('Vote' + val);
            const up = vote.parentElement.querySelector('.up');
            const down = vote.parentElement.querySelector('.down');

            //#endregion

            //#region localStorage

            let cacheVote = votelist.filter(vote => vote.id === val)[0];

            if (cacheVote?.isUp) return;
            up.classList.remove('link-active');
            down.classList.remove('link-active');

            if (cacheVote)
                votelist.splice(votelist.indexOf(cacheVote), 1);

            up.classList.add('link-active');

            votelist.push({ id: val, isUp: true });
            // update local storage
            localStorage.setItem(votelistKey, JSON.stringify(votelist));

            //#endregion

            var result = Bjax("/Forum/VoteUp?id=", val, "SP");
            if (result) {
                var vote = document.getElementById('Vote' + val);
                vote.innerText = parseInt(vote.innerText) + 1;
            } else {
                window.location = "";
            }
        }

        function VoteDown(val) {

            //#region buts
            var vote = document.getElementById('Vote' + val);
            const up = vote.parentElement.querySelector('.up');
            const down = vote.parentElement.querySelector('.down');

            //#endregion

            //#region localStorage

            let cacheVote = votelist.filter(vote => vote.id === val)[0];

            if (!cacheVote?.isUp) return;
            up.classList.remove('link-active');
            down.classList.remove('link-active');

            if (cacheVote)
                votelist.splice(votelist.indexOf(cacheVote), 1);

            down.classList.add('link-active');

            votelist.push({ id: val, isUp: false });
            // update local storage
            localStorage.setItem(votelistKey, JSON.stringify(votelist));

            //#endregion

            var result = Bjax("/Forum/VoteDown?id=", val, "SP");
            if (result) {
                vote.innerText = parseInt(vote.innerText) - 1;
            } else {
                window.location = "";
            }
        }
    </script>

}